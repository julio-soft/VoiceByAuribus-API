# AWS Resources Setup Guide

This document describes all AWS resources required for the VoiceByAuribus API project.

## Overview

The application uses the following AWS services:
- **AWS Cognito**: User authentication (M2M tokens)
- **Amazon S3**: Storage for voice models and audio files
- **Amazon SQS**: Queue for audio preprocessing tasks
- **AWS Lambda**: S3 event handler for upload notifications
- **IAM**: Roles and policies for service access

---

## S3 Buckets

### 1. Audio Files Bucket

**Bucket Name**: `voice-by-auribus-audio-files` (configurable in appsettings.json)

**Purpose**: Stores user-uploaded audio files and their processed versions

**Folder Structure**:
```
audio-files/
  {userId}/
    temp/       # Original uploaded files
    short/      # 10-second preview files (generated by preprocessing)
    inference/  # Processed files ready for inference
```

**Required Configuration**:

1. **CORS Policy** (to allow pre-signed URL uploads):
```json
[
  {
    "AllowedHeaders": ["*"],
    "AllowedMethods": ["PUT", "GET"],
    "AllowedOrigins": ["*"],
    "ExposeHeaders": ["ETag"]
  }
]
```

2. **Event Notifications**:
   - Event name: `AudioFileUploadNotification`
   - Events: `s3:ObjectCreated:*` (specifically PUT)
   - Prefix: `audio-files/`
   - Suffix: (optional, leave blank for all audio formats)
   - Destination: Lambda function `VoiceByAuribus-AudioUploadNotifier`

3. **Lifecycle Policy** (Optional - for temp file cleanup):
```json
{
  "Rules": [
    {
      "Id": "DeleteTempFilesAfter90Days",
      "Status": "Enabled",
      "Prefix": "audio-files/",
      "Filter": {
        "And": {
          "Prefix": "audio-files/",
          "Tags": []
        }
      },
      "Expiration": {
        "Days": 90
      }
    }
  ]
}
```

**IAM Permissions Required**:
- API Backend: `s3:PutObject`, `s3:GetObject`, `s3:GetObjectMetadata`
- Lambda: `s3:GetObject`, `s3:GetObjectMetadata`
- Preprocessing Service: `s3:GetObject`, `s3:PutObject`

---

## SQS Queues

### 1. Audio Preprocessing Queue

**Queue Name**: `audio-preprocessing-queue`

**Purpose**: Manages audio preprocessing tasks sent from backend to external service

**Configuration**:
- **Queue Type**: Standard
- **Visibility Timeout**: 5 minutes (adjust based on preprocessing time)
- **Message Retention**: 4 days
- **Max Message Size**: 256 KB
- **Receive Message Wait Time**: 0 seconds (short polling) or 20 seconds (long polling recommended)

**Dead Letter Queue** (Recommended):
- **Queue Name**: `audio-preprocessing-dlq`
- **Max Receives**: 3 (after 3 failed processing attempts, move to DLQ)

**Message Format**:
```json
{
  "s3_key_temp": "s3://voice-by-auribus-audio-files/audio-files/{userId}/temp/{fileId}.mp3",
  "s3_key_short": "s3://voice-by-auribus-audio-files/audio-files/{userId}/short/{fileId}.mp3",
  "s3_key_for_inference": "s3://voice-by-auribus-audio-files/audio-files/{userId}/inference/{fileId}.mp3",
  "request_id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "callback_response": {
    "url": "https://api.example.com/api/v1/audio-files/webhooks/preprocessing-result",
    "type": "HTTP"
  }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `s3_key_temp` | string | Full S3 URI for the temporary (original) uploaded audio file. Format: `s3://bucket/path` |
| `s3_key_short` | string | Full S3 URI where the short preview audio will be stored |
| `s3_key_for_inference` | string | Full S3 URI where the inference-ready audio will be stored |
| `request_id` | string (optional) | Unique identifier for tracking (AudioFileId is used) |
| `callback_response` | object (optional) | Callback configuration for receiving processing results |
| `callback_response.url` | string | Destination URL (HTTP endpoint or SQS queue URL) |
| `callback_response.type` | string | Either `"HTTP"` or `"SQS"` |

**IAM Permissions Required**:
- API Backend: `sqs:SendMessage`, `sqs:GetQueueUrl`
- Preprocessing Service: `sqs:ReceiveMessage`, `sqs:DeleteMessage`, `sqs:ChangeMessageVisibility`

**Queue URL Format**:
```
https://sqs.{region}.amazonaws.com/{accountId}/audio-preprocessing-queue
```

Add to appsettings.json:
```json
{
  "AWS": {
    "SQS": {
      "AudioPreprocessingQueueUrl": "https://sqs.us-east-1.amazonaws.com/123456789012/audio-preprocessing-queue"
    }
  }
}
```

---

## Lambda Functions

### 1. VoiceByAuribus-AudioUploadNotifier

**Runtime**: .NET 10.0

**Purpose**: Receives S3 upload events and notifies backend API via webhook

**Trigger**: S3 Event Notification from `voice-by-auribus-audio-files` bucket

**Environment Variables**:
- `API_BASE_URL`: Base URL of VoiceByAuribus API (e.g., `https://api.voicebyauribus.com`)
- `WEBHOOK_API_KEY`: Secure API key matching `Webhooks:ApiKey` in backend appsettings.json

**Memory**: 256 MB (adjust as needed)

**Timeout**: 30 seconds

**Handler**: `VoiceByAuribus.AudioUploadNotifier::VoiceByAuribus.AudioUploadNotifier.Function::FunctionHandler`

**Execution Role Permissions**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:GetObjectMetadata"
      ],
      "Resource": "arn:aws:s3:::voice-by-auribus-audio-files/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:*:*:*"
    }
  ]
}
```

**Deployment**:
```bash
cd VoiceByAuribus.AudioUploadNotifier/src/VoiceByAuribus.AudioUploadNotifier
dotnet lambda deploy-function VoiceByAuribus-AudioUploadNotifier
```

**Monitoring**:
- CloudWatch Log Group: `/aws/lambda/VoiceByAuribus-AudioUploadNotifier`
- Metrics: Invocations, Errors, Duration, Throttles

---

## AWS Cognito

### User Pool Configuration

**User Pool ID**: Configured in appsettings.json `Authentication:Cognito:UserPoolId`

**Resource Server**:
- **Identifier**: `voice-by-auribus-api`
- **Scopes**:
  - `voice-by-auribus-api/base`: Regular user access
  - `voice-by-auribus-api/admin`: Admin access (internal paths, preprocessing data)

**App Client**:
- **Type**: Machine-to-Machine (M2M)
- **Authentication Flow**: `CLIENT_CREDENTIALS`
- **Allowed OAuth Flows**: Client credentials
- **Allowed OAuth Scopes**: `voice-by-auribus-api/base`, `voice-by-auribus-api/admin`

**Token Configuration**:
- M2M tokens do NOT include `aud` claim by default
- Backend validates `scope` claim instead
- See `.ai_doc/COGNITO_M2M_AUTH.md` for detailed authentication flow

---

## IAM Roles and Policies

### API Backend EC2/ECS Role

Required permissions:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "S3AudioFiles",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:GetObjectMetadata"
      ],
      "Resource": "arn:aws:s3:::voice-by-auribus-audio-files/*"
    },
    {
      "Sid": "SQSPreprocessing",
      "Effect": "Allow",
      "Action": [
        "sqs:SendMessage",
        "sqs:GetQueueUrl"
      ],
      "Resource": "arn:aws:sqs:*:*:audio-preprocessing-queue"
    }
  ]
}
```

### Lambda Execution Role

See Lambda section above for required permissions.

### Preprocessing Service Role

Required permissions:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "S3AudioFiles",
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject"
      ],
      "Resource": "arn:aws:s3:::voice-by-auribus-audio-files/*"
    },
    {
      "Sid": "SQSPreprocessing",
      "Effect": "Allow",
      "Action": [
        "sqs:ReceiveMessage",
        "sqs:DeleteMessage",
        "sqs:ChangeMessageVisibility",
        "sqs:GetQueueAttributes"
      ],
      "Resource": "arn:aws:sqs:*:*:audio-preprocessing-queue"
    }
  ]
}
```

---

## Configuration Summary

### Backend appsettings.json

```json
{
  "AWS": {
    "Region": "us-east-1",
    "Profile": "default",
    "S3": {
      "AudioFilesBucket": "voice-by-auribus-audio-files",
      "UploadUrlExpirationMinutes": 30,
      "MaxFileSizeMB": 100
    },
    "SQS": {
      "AudioPreprocessingQueueUrl": "https://sqs.us-east-1.amazonaws.com/{accountId}/audio-preprocessing-queue"
    }
  },
  "Webhooks": {
    "ApiKey": "CHANGE_THIS_TO_SECURE_VALUE"
  },
  "Authentication": {
    "Cognito": {
      "Region": "us-east-1",
      "UserPoolId": "us-east-1_XXXXXXXXX",
      "Audience": "voice-by-auribus-api"
    }
  }
}
```

### Lambda Environment Variables

```
API_BASE_URL=https://api.voicebyauribus.com
WEBHOOK_API_KEY=SAME_AS_BACKEND_WEBHOOKS_APIKEY
```

---

## Setup Checklist

- [ ] Create S3 bucket `voice-by-auribus-audio-files`
- [ ] Configure S3 CORS policy for pre-signed uploads
- [ ] Create SQS queue `audio-preprocessing-queue`
- [ ] Create SQS Dead Letter Queue `audio-preprocessing-dlq`
- [ ] Deploy Lambda function `VoiceByAuribus-AudioUploadNotifier`
- [ ] Configure Lambda environment variables
- [ ] Set up S3 event notification to trigger Lambda
- [ ] Create IAM roles with appropriate permissions
- [ ] Update backend appsettings.json with AWS resource URLs
- [ ] Verify Cognito resource server and scopes are configured
- [ ] Test end-to-end flow: upload → notification → preprocessing

---

## Monitoring and Troubleshooting

### CloudWatch Logs

- **Backend API**: Application logs (check for SQS send errors, S3 upload URL generation)
- **Lambda Function**: `/aws/lambda/VoiceByAuribus-AudioUploadNotifier`
- **Preprocessing Service**: Custom log group

### CloudWatch Metrics

- **S3**: Number of PUT requests, storage size
- **SQS**: Messages sent, messages received, age of oldest message
- **Lambda**: Invocations, errors, duration, concurrent executions

### Common Issues

1. **Lambda not triggered on upload**:
   - Check S3 event notification configuration
   - Verify Lambda has permission to be invoked by S3
   - Check CloudWatch Logs for Lambda errors

2. **Backend webhook returns 401**:
   - Verify `WEBHOOK_API_KEY` in Lambda matches `Webhooks:ApiKey` in backend
   - Check `X-Webhook-Api-Key` header is being sent

3. **Preprocessing messages not processed**:
   - Check SQS queue for messages in DLQ
   - Verify preprocessing service has SQS permissions
   - Check visibility timeout is sufficient for processing time

4. **Pre-signed URL upload fails**:
   - Verify S3 CORS configuration
   - Check URL hasn't expired (30 min default)
   - Ensure Content-Type header matches MIME type

---

## Cost Optimization

- **S3 Lifecycle Policies**: Move old files to Glacier or delete after retention period
- **SQS Long Polling**: Reduces empty receive requests
- **Lambda Memory**: Right-size based on actual usage metrics
- **S3 Intelligent-Tiering**: Automatically moves objects between access tiers

---

## Security Best Practices

1. **API Keys**: Rotate webhook API keys regularly
2. **S3 Bucket Policy**: Restrict access to specific IAM roles
3. **Encryption**: Enable S3 bucket encryption at rest (AES-256 or KMS)
4. **VPC**: Deploy Lambda in VPC if backend API is private
5. **Least Privilege**: IAM roles should have minimum required permissions
6. **Audit Logging**: Enable CloudTrail for API calls to AWS services
